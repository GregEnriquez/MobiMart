<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:view="clr-namespace:MobiMart.View"
             xmlns:viewmodel="clr-namespace:MobiMart.ViewModel"
             x:DataType="viewmodel:TransactionViewModel"
             x:Class="MobiMart.View.TransactionPage"
             xmlns:model="clr-namespace:MobiMart.Model"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:zxing="clr-namespace:ZXing.Net.Maui.Controls;assembly=ZXing.Net.MAUI.Controls"
             x:Name="RootPage"
             BackgroundColor="#FDF4DC"
             Title="TransactionPage">

    <!-- <Shell.TitleView>
        <Grid ColumnDefinitions="Auto, *">
            <ImageButton
                Grid.Column="0"
                Source="hamburger_icon.png"
                HeightRequest="24"
                WidthRequest="24"
                Clicked="OnHamburgerClicked" />

            <Label
                Grid.ColumnSpan="2"
                Text="MobiMart"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                FontSize="20"
                TextColor="White"
                FontAttributes="Bold" />
        </Grid>
    </Shell.TitleView> -->

    <Grid RowDefinitions="Auto, *, Auto, Auto, Auto" Padding="10">

        <Label Grid.Row="0"
               Text="Transaction Page"
               HorizontalOptions="Center"
               VerticalOptions="Center"
               TextColor="#6D5206"
               FontSize="18"
               FontAttributes="Bold"
               Padding="10"/>

        <Frame Grid.Row="1"
               BackgroundColor="#F6CD5E"
               CornerRadius="10"
               Padding="10"
               Margin="0"
               BorderColor="#6D5206"
               VerticalOptions="FillAndExpand">

            <Grid RowDefinitions="Auto, *" VerticalOptions="FillAndExpand">

                <StackLayout Grid.Row="0" Spacing="10">
                    <Label Text="Transaction List"
                           FontAttributes="Bold"
                           FontSize="16"
                           TextColor="#6D5206"/>
                    <BoxView  HeightRequest="1" BackgroundColor="#6D5206" VerticalOptions="End" />
                    <Grid ColumnDefinitions="220, *, *, *" Padding="0">
                        <Label Text="Item Name" TextColor="#6D5206" FontAttributes="Bold" />
                        <Label Grid.Column="1" Text="Qty." TextColor="#6D5206" FontAttributes="Bold" HorizontalOptions="Center"/>
                        <Label Grid.Column="2" Text="Price" TextColor="#6D5206" FontAttributes="Bold" HorizontalOptions="Center"/>
                        <Label Grid.Column="3" Text="Void" TextColor="#6D5206" FontAttributes="Bold" HorizontalOptions="Center"/>
                    </Grid>
                    <BoxView  HeightRequest="1" BackgroundColor="#6D5206" VerticalOptions="End" />
                </StackLayout>

                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding Items}"
                                Margin="0,5,0,0"
                                x:Name="TransactionsCollection">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:Transaction">
                                <Grid ColumnDefinitions="220, *, *, *" Padding="0" ColumnSpacing="5" Grid.Row="0">
<!-- ======================================================================================================== -->
                                    <Border Stroke="#6D5206" 
                                            StrokeThickness="1" 
                                            StrokeShape="RoundRectangle 10,10,10,10">
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border"
                                                        Binding="{Binding IsBarcodeEntry}"
                                                        Value="false">
                                                <Setter Property="IsVisible" Value="True"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Border"
                                                        Binding="{Binding IsBarcodeEntry}"
                                                        Value="true">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                        </Border.Triggers>
                                        <!-- <Entry Text="{Binding ItemName, Mode=TwoWay}" TextColor="#6D5206" Placeholder="Enter Item name/barcode" TextChanged="OnItemNameEntryTextChanged"/> -->
                                        <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                                            <Picker x:Name="itemPicker"
                                                Title="Select Item"
                                                ItemsSource="{Binding BindingContext.AllItems, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                ItemDisplayBinding="{Binding Name}"
                                                SelectedItem="{Binding SelectedItem}"
                                                SelectedIndexChanged="OnItemSelected"
                                                TextColor="#6D5206"
                                                HorizontalOptions="Fill">
                                            </Picker>
                                            <Button Text="⇆"
                                                BackgroundColor="Transparent"
                                                Grid.Column="1"
                                                TextColor="#A9882D"
                                                WidthRequest="30"
                                                HeightRequest="30"
                                                FontSize="18"
                                                Command="{Binding BindingContext.ToggleBarcodeCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid>
                                    </Border>
                                    <Border
                                        x:Name="BarcodeEntry"
                                        Stroke="#A9882D"
                                        StrokeThickness="1.5"
                                        StrokeShape="RoundRectangle 10,10,10,10"
                                        IsVisible="{Binding IsBarcodeEntry}"
                                        HorizontalOptions="Center"
                                        VerticalOptions="Center">

                                        <Grid ColumnDefinitions="*,Auto,Auto"
                                            VerticalOptions="Center">

                                            <!-- Entry for manual input -->
                                            <Entry Grid.Column="0"
                                                Placeholder="Enter Barcode" 
                                                Keyboard="Numeric"
                                                   Text="{Binding BarcodeId}"
                                                TextChanged="OnBarcodeEntryTextChanged"
                                                BackgroundColor="Transparent"
                                                TextColor="#FF7C631E"
                                                PlaceholderColor="#FF7C7272"
                                                Margin="0,0,5,0" />

                                            <!-- Button to scan barcode -->
                                            <ImageButton Grid.Column="1"
                                                        Source="scan_icon.png" 
                                                        BackgroundColor="Transparent" 
                                                        WidthRequest="10" 
                                                        HeightRequest="10"
                                                        Command="{Binding BindingContext.ShowScannerCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}" 
                                                        HorizontalOptions="Center"
                                                        VerticalOptions="Center"/>

                                            <Button Text="⇆"
                                                BackgroundColor="Transparent"
                                                Grid.Column="3"
                                                TextColor="#A9882D"
                                                WidthRequest="30"
                                                HeightRequest="30"
                                                FontSize="18"
                                                Command="{Binding BindingContext.ToggleBarcodeCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid>
                                    </Border>

 <!-- ======================================================================================================== -->

                                    <Border Stroke="#6D5206" 
                                            StrokeThickness="1" 
                                            StrokeShape="RoundRectangle 10,10,10,10"
                                            Grid.Column="1">
                                        <Entry Text="{Binding Quantity, Mode=TwoWay}" Keyboard="Numeric" WidthRequest="50" HorizontalOptions="Center" TextColor="#6D5206" Placeholder="0"/>
                                    </Border>
                                    <Border Stroke="#6D5206" 
                                            StrokeThickness="1" 
                                            StrokeShape="RoundRectangle 10,10,10,10"
                                            Grid.Column="2">
                                        <Entry Text="{Binding Price, Mode=TwoWay}" Keyboard="Numeric" WidthRequest="50" HorizontalOptions="Center" IsEnabled="False" TextColor="#6D5206" Placeholder="0"/>
                                    </Border>

                                    <Button Text="X"
                                        Grid.Column="3"
                                        BackgroundColor="#FFB9680C"
                                        TextColor="White"
                                        WidthRequest="25"
                                        HeightRequest="25"
                                        CornerRadius="20"
                                        Command="{Binding BindingContext.DeleteTransactionCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                        CommandParameter="{Binding .}"/>
                                </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Frame>

        <HorizontalStackLayout Grid.Row="2" Padding="5" HorizontalOptions="Center">
            <Frame Padding="5" HasShadow="False" BackgroundColor="Transparent" BorderColor="Transparent">
                <HorizontalStackLayout Spacing="5" VerticalOptions="Center">
                    <Image Source="add_icon.png" WidthRequest="24" HeightRequest="24"/>
                    <Label Text="Add Item"
                           VerticalOptions="Center"
                           TextColor="#6D5206"
                           FontAttributes="Bold"/>
                </HorizontalStackLayout>

                <Frame.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding AddItemCommand}" />
                </Frame.GestureRecognizers>
            </Frame>
        </HorizontalStackLayout>

        <BoxView  Grid.Row="2" HeightRequest="1" BackgroundColor="#6D5206" VerticalOptions="End" />
        
        <HorizontalStackLayout Grid.Row="3" Padding="15,5" HorizontalOptions="Start">
            <Label Text="Total Price:" FontAttributes="Bold" TextColor="#6D5206"/>
            <Label Text="{Binding TotalPrice}" FontAttributes="Bold" TextColor="#6D5206" Margin="5,0,0,0"/>
        </HorizontalStackLayout>
        
        <HorizontalStackLayout Grid.Row="3" Padding="15,5" HorizontalOptions="Start" Spacing="5">
            <Label Text="Payment:" FontAttributes="Bold" TextColor="#6D5206" VerticalOptions="Center"/>
            <Border Stroke="#6D5206" 
                    StrokeThickness="1" 
                    StrokeShape="RoundRectangle 10,10,10,10"
                    HeightRequest="45"
                    VerticalOptions="Center"
                    Padding="0,0">
                <Entry Text="{Binding Payment, Mode=TwoWay}" 
                   Keyboard="Numeric"
                   Placeholder="0"
                   WidthRequest="50"
                   HeightRequest="30"
                   TextColor="#6D5206"
                   Margin="0,0,0,0"
                   VerticalOptions="Center"
                   TextChanged="OnPaymentTextChanged"/>
            </Border>
        </HorizontalStackLayout>

        <HorizontalStackLayout Grid.Row="3" Padding="15,5" HorizontalOptions="Start" Margin="0,70,0,0">
            <Label Text="Change:" FontAttributes="Bold" TextColor="#6D5206"/>
            <Label Text="{Binding Change}" FontAttributes="Bold" TextColor="#6D5206" Margin="5,0,0,0"/>
        </HorizontalStackLayout>

<!-- =================================================================================================================== -->

        <Grid x:Name="ScannerOverlay"
            BackgroundColor="Transparent"
            IsVisible="{Binding IsScannerVisible}"
            InputTransparent="False"
            AbsoluteLayout.LayoutFlags="All"
            AbsoluteLayout.LayoutBounds="0,0,1,1"
            ZIndex="10">

            <VerticalStackLayout
                VerticalOptions="Center"
                HorizontalOptions="Center">
                <zxing:CameraBarcodeReaderView
                    x:Name="barcodeReader"
                    HorizontalOptions="Fill"
                    VerticalOptions="Fill"
                    HeightRequest="250"
                    WidthRequest="350"
                    BarcodesDetected="BarcodeReader_BarcodesDetected"/>
                <HorizontalStackLayout 
                    Margin="0,50,0,0"
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    Spacing="10">

                    <Button Text="X"
                            BackgroundColor="Red"
                            TextColor="White"
                            WidthRequest="40"
                            HeightRequest="40"
                            CornerRadius="20"
                            Command="{Binding HideScannerCommand}"/>
                    <Button Text="T"
                            BackgroundColor="Green"
                            TextColor="White"
                            WidthRequest="40"
                            HeightRequest="40"
                            CornerRadius="20"
                            Pressed="OnPressedTorchButton"/>
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Grid>

<!-- =================================================================================================================== -->

        <Button Grid.Row="4"
                Command="{Binding SaveTransactionCommand}"
                Text="Save Transaction"
                TextColor="#6D5206"
                BackgroundColor="#FBE7B3"
                BorderColor="#6D5206"
                BorderWidth="2"
                CornerRadius="20"
                HeightRequest="40"
                HorizontalOptions="Center"
                WidthRequest="200"
                Margin="0,10,0,10" />

    </Grid>
</ContentPage>